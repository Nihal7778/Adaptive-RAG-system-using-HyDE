<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediRAG Assistant</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Your custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="app-bg">
  <div class="container py-3 py-lg-4">
    <div class="row justify-content-center">
      <div class="col-12 col-xl-10 col-xxl-9">

        <!-- APP SHELL -->
        <div class="app-shell shadow-lg overflow-hidden">

          <!-- HEADER -->
          <header class="app-header px-3 px-md-4 py-3">
            <div class="d-flex align-items-center gap-3">
              <div class="brand-badge">
                <i class="bi bi-heart-pulse-fill"></i>
              </div>

              <div class="flex-grow-1">
                <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                  <div>
                    <h1 class="h5 mb-0 fw-semibold text-white">MediRAG Assistant</h1>
                    <div class="small text-white-50 d-flex align-items-center gap-2">
                      <span class="status-dot"></span>
                      <span id="statusText">Online • Source-grounded answers</span>
                    </div>
                  </div>

                <div class="d-flex align-items-center gap-2">
                  <button id="toggleSourcesBtn" class="btn btn-sm btn-outline-light soft-btn" type="button">
                    <i class="bi bi-journal-text me-1"></i> Sources: <span id="sourcesState">On</span>
                      </button>
                 <button id="manageDocsBtn" class="btn btn-sm btn-outline-light soft-btn" type="button" data-bs-toggle="modal" data-bs-target="#docsModal">
                   <i class="bi bi-folder2-open me-1"></i> Docs
                    </button>
                      <button id="clearChatBtn" class="btn btn-sm btn-light soft-btn" type="button">
                       <i class="bi bi-trash3 me-1"></i> Clear
                    </button>
                    <button id="clearHistoryBtn" class="btn btn-sm btn-warning soft-btn" type="button">
                      <i class="bi bi-clock-history me-1"></i> Clear Memory
                  </button>
                  </div>


                </div>
                <!-- DOCUMENT SELECTOR -->
                <div class="px-3 px-md-4 py-2 bg-light border-bottom">
                 <div class="d-flex align-items-center gap-2 flex-wrap">
                   <small class="text-muted fw-semibold">Query from:</small>
                     <div id="docCheckboxes" class="d-flex flex-wrap gap-2">
               <!-- Dynamically populated -->
                </div>
                  <button id="refreshDocsBtn" class="btn btn-sm btn-outline-secondary ms-auto" type="button">
                     <i class="bi bi-arrow-clockwise"></i> Refresh
                   </button>
               </div>
                </div>
              </div>
            </div>
          </header>

          <!-- CHAT BODY -->
          <main class="app-body" id="chatBody">
            <!-- Welcome -->
            <div class="welcome-wrap">
              <div class="welcome-card">
                <div class="d-flex align-items-start gap-3">
                  <div class="welcome-icon">
                    <i class="bi bi-chat-dots"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h2 class="h6 fw-semibold mb-1 text-light">Ask about topics from the PDF</h2>
                    <p class="text-white mb-2">
                      I'll search the book and answer using the most relevant sections. If it's not in the document, I'll say so.
                    </p>

                    <div class="d-flex flex-wrap gap-2">
                      <button class="chip" data-prompt="What is acne?">What is acne?</button>
                      <button class="chip" data-prompt="Explain symptoms of diabetes.">Symptoms of diabetes</button>
                      <button class="chip" data-prompt="What are common causes of fever?">Causes of fever</button>
                      <button class="chip" data-prompt="Summarize treatment options for asthma.">Asthma treatment</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Messages will render here -->
            <div id="messages" class="messages"></div>

            <!-- Typing indicator -->
            <div id="typing" class="typing d-none">
              <div class="bubble bot-bubble">
                <div class="d-flex align-items-center gap-2">
                  <span class="bot-avatar"><i class="bi bi-heart-pulse"></i></span>
                  <span class="typing-dots" aria-label="Assistant typing">
                    <span></span><span></span><span></span>
                  </span>
                  <span class="small text-muted">Searching the book…</span>
                </div>
              </div>
            </div>
          </main>

          <!-- FOOTER -->
          <footer class="app-footer px-3 px-md-4 py-3">
            <form id="chatForm" class="w-100">
              <!-- HyDE Toggle -->
            <div class="mb-3">
              <div class="d-flex align-items-center justify-content-between">
                <div class="form-check form-switch m-0">
             <input class="form-check-input border-secondary" type="checkbox" id="hydeToggle">
             <label class="form-check-label text-light" for="hydeToggle">
             <span class="fw-semibold">Use HyDE</span>
             <span class="text-light small ms-1">(Better retrieval)</span>
      </label>
    </div>
  </div>

            <div id="hydeInfo" class="alert alert-info py-2 px-3 small mt-2 d-none">
             <i class="bi bi-info-circle me-2"></i>
             <span id="hydeHypothesis"></span>
             </div>
            </div>

<div class="input-group input-group-lg chat-input-wrap">
  <span class="input-group-text input-icon">
    <i class="bi bi-search-heart"></i>
  </span>


                <textarea
                  id="userInput"
                  class="form-control chat-input"
                  placeholder="Ask a question… (Press Enter to send, Shift+Enter for new line)"
                  rows="1"
                  maxlength="1200"
                ></textarea>

                <button id="sendBtn" class="btn btn-primary send-btn" type="submit">
                  <i class="bi bi-send-fill me-1"></i> Send
                </button>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="small text-white">
                  Tip: ask specific questions for better retrieval (e.g., "symptoms of X", "treatment for Y").
                </div>
                <div class="small text-muted" id="charCount">0 / 1200</div>
              </div>
            </form>
          </footer>

        </div>
        <!-- /APP SHELL -->

      </div>
    </div>
  </div>

  <!-- DOCUMENT MANAGEMENT MODAL -->
<div class="modal fade" id="docsModal" tabindex="-1" aria-labelledby="docsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="docsModalLabel">
          <i class="bi bi-folder2-open me-2"></i>Manage Documents
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Upload Section -->
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">
            <i class="bi bi-cloud-upload me-2"></i>Upload New PDF
          </div>
          <div class="card-body">
            <form id="uploadForm">
              <div class="input-group">
                <input type="file" class="form-control" id="pdfFile" accept=".pdf" required>
                <button class="btn btn-primary" type="submit" id="uploadBtn">
                  <i class="bi bi-upload me-1"></i> Upload
                </button>
              </div>
              <div class="form-text">Max 50MB. Only PDF files allowed.</div>
              <div id="uploadStatus" class="mt-2"></div>
            </form>
          </div>
        </div>

        <!-- Document List -->
        <div class="card">
          <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-files me-2"></i>Your Documents</span>
            <button id="reindexBtn" class="btn btn-sm btn-light" type="button">
              <i class="bi bi-arrow-repeat me-1"></i> Reindex All
            </button>
          </div>
          <div class="card-body">
            <div id="documentList">
              <!-- Dynamically populated -->
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

 <script>
  // ---- Chat JS with Multi-Document Support + HyDE ----
  const messagesEl = document.getElementById("messages");
  const typingEl = document.getElementById("typing");
  const chatBodyEl = document.getElementById("chatBody");
  const formEl = document.getElementById("chatForm");
  const inputEl = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const clearChatBtn = document.getElementById("clearChatBtn");
  const toggleSourcesBtn = document.getElementById("toggleSourcesBtn");
  const sourcesStateEl = document.getElementById("sourcesState");
  const charCountEl = document.getElementById("charCount");
  const docCheckboxesEl = document.getElementById("docCheckboxes");
  const refreshDocsBtn = document.getElementById("refreshDocsBtn");
  const uploadForm = document.getElementById("uploadForm");
  const uploadBtn = document.getElementById("uploadBtn");
  const uploadStatus = document.getElementById("uploadStatus");
  const reindexBtn = document.getElementById("reindexBtn");
  const documentListEl = document.getElementById("documentList");

  let showSources = true;
  let documents = [];

  function scrollToBottom() {
    chatBodyEl.scrollTop = chatBodyEl.scrollHeight;
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[s]));
  }

  function nowTime() {
    const d = new Date();
    return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }

  function addMessage({ role, text, sources = [] }) {
    const isUser = role === "user";
    const msg = document.createElement("div");
    msg.className = `msg-row ${isUser ? "msg-user" : "msg-bot"}`;

    const safeText = escapeHtml(text).replace(/\n/g, "<br>");
    const sourcesHtml = (sources && sources.length)
? `
  <details class="sources mt-2 ${showSources ? "" : "d-none"}">
    <summary><i class="bi bi-journal-text me-1"></i>View sources</summary>
    <ul class="mt-2 mb-0">
      ${sources.map(s => `<li>${escapeHtml(s)}</li>`).join("")}
    </ul>
  </details>
`
: "";

    msg.innerHTML = `
      <div class="bubble ${isUser ? "user-bubble" : "bot-bubble"}">
        <div class="bubble-top">
          <span class="${isUser ? "user-avatar" : "bot-avatar"}">
            <i class="bi ${isUser ? "bi-person-fill" : "bi-heart-pulse"}"></i>
          </span>
          <span class="bubble-role">${isUser ? "You" : "MediRAG"}</span>
          <span class="bubble-time ms-auto">${nowTime()}</span>
        </div>
        <div class="bubble-text">${safeText}</div>
        ${sourcesHtml}
      </div>
    `;

    messagesEl.appendChild(msg);
    scrollToBottom();
  }

  function setTyping(isTyping) {
    typingEl.classList.toggle("d-none", !isTyping);
    scrollToBottom();
  }

  function autoGrow(el) {
    el.style.height = "auto";
    el.style.height = Math.min(el.scrollHeight, 160) + "px";
  }

  // Fetch and render documents
  async function loadDocuments() {
    try {
      const res = await fetch("/documents");
      const data = await res.json();
      const historyText = chatHistory.slice(-10).map(m => 
      `${m.role === "user" ? "User" : "Assistant"}: ${m.content}`
      ).join("\n");
      body.append("history", historyText);
      documents = data.documents || [];
      renderDocumentCheckboxes();
      renderDocumentList();
    } catch (err) {
      console.error("Failed to load documents:", err);
    }
  }

  function renderDocumentCheckboxes() {
    docCheckboxesEl.innerHTML = documents.map(doc => `
      <div class="form-check">
        <input class="form-check-input doc-checkbox" type="checkbox" value="${doc.doc_id}" id="doc-${doc.doc_id}" ${doc.is_protected ? 'checked' : ''}>
        <label class="form-check-label small" for="doc-${doc.doc_id}">
          ${escapeHtml(doc.filename)} ${doc.is_protected ? '<i class="bi bi-lock-fill text-muted"></i>' : ''}
        </label>
      </div>
    `).join("");
  }

  function renderDocumentList() {
    if (documents.length === 0) {
      documentListEl.innerHTML = '<p class="text-muted">No documents uploaded yet.</p>';
      return;
    }

    documentListEl.innerHTML = documents.map(doc => `
      <div class="d-flex justify-content-between align-items-center border-bottom py-2">
        <div>
          <strong>${escapeHtml(doc.filename)}</strong>
          ${doc.is_protected ? '<span class="badge bg-secondary ms-2">Protected</span>' : ''}
          <br>
          <small class="text-muted">
            ${doc.num_chunks} chunks • Status: ${doc.status} • Uploaded: ${new Date(doc.upload_date).toLocaleDateString()}
          </small>
        </div>
        <div>
          ${doc.is_protected ? '' : `<button class="btn btn-sm btn-danger delete-doc-btn" data-doc-id="${doc.doc_id}" data-filename="${escapeHtml(doc.filename)}"><i class="bi bi-trash"></i></button>`}
        </div>
      </div>
    `).join("");

    // Attach delete handlers
    document.querySelectorAll(".delete-doc-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const docId = btn.dataset.docId;
        const filename = btn.dataset.filename;
        if (!confirm(`Delete "${filename}"? This will remove all indexed content.`)) return;

        try {
          const res = await fetch(`/delete/${docId}`, { method: "DELETE" });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            loadDocuments();
          } else {
            alert("Error: " + data.error);
          }
        } catch (err) {
          alert("Failed to delete document");
        }
      });
    });
  }

  function getSelectedDocIds() {
    const checkboxes = document.querySelectorAll(".doc-checkbox:checked");
    return Array.from(checkboxes).map(cb => cb.value);
  }

  // Upload handler
  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById("pdfFile");
    const file = fileInput.files[0];
    if (!file) return;

    uploadBtn.disabled = true;
    uploadStatus.innerHTML = '<div class="alert alert-info">Uploading...</div>';

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch("/upload", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      
      if (data.success) {
        uploadStatus.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        fileInput.value = "";
        loadDocuments();
      } else {
        uploadStatus.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
      }
    } catch (err) {
      uploadStatus.innerHTML = '<div class="alert alert-danger">Upload failed</div>';
    } finally {
      uploadBtn.disabled = false;
    }
  });

  // Reindex handler
  reindexBtn.addEventListener("click", async () => {
    if (!confirm("Reindex all documents? This may take 2-5 minutes.")) return;

    reindexBtn.disabled = true;
    reindexBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Reindexing...';

    try {
      const res = await fetch("/reindex", { method: "POST" });
      const data = await res.json();
      
      if (data.success) {
        alert(data.message);
        loadDocuments();
      } else {
        alert("Error: " + data.error);
      }
    } catch (err) {
      alert("Reindex failed");
    } finally {
      reindexBtn.disabled = false;
      reindexBtn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i> Reindex All';
    }
  });

  // Refresh documents
  refreshDocsBtn.addEventListener("click", loadDocuments);

  // Input handlers
  inputEl.addEventListener("input", () => {
    autoGrow(inputEl);
    charCountEl.textContent = `${inputEl.value.length} / 1200`;
  });

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      formEl.requestSubmit();
    }
  });

  document.querySelectorAll(".chip").forEach(btn => {
    btn.addEventListener("click", () => {
      inputEl.value = btn.dataset.prompt || "";
      autoGrow(inputEl);
      charCountEl.textContent = `${inputEl.value.length} / 1200`;
      inputEl.focus();
    });
  });

  clearChatBtn.addEventListener("click", () => {
    messagesEl.innerHTML = "";
    setTyping(false);
    scrollToBottom();
  });

  // Clear conversation memory
  document.getElementById("clearHistoryBtn").addEventListener("click", async () => {
  await fetch("/clear_history", {method: "POST"});
  alert("Conversation memory cleared!");
  });

  toggleSourcesBtn.addEventListener("click", () => {
    showSources = !showSources;
    sourcesStateEl.textContent = showSources ? "On" : "Off";
  });

  // Main submit handler with HyDE support
  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = inputEl.value.trim();
    if (!text) return;

    addMessage({ role: "user", text });
    chatHistory.push({role: "user", content: text});
    inputEl.value = "";
    autoGrow(inputEl);
    charCountEl.textContent = "0 / 1200";
    chatHistory.push({role: "user", content: text});

    setTyping(true);
    sendBtn.disabled = true;

    try {
      // Check if HyDE mode is enabled
      const hydeEnabled = document.getElementById("hydeToggle").checked;
      const endpoint = hydeEnabled ? "/get_hyde" : "/get";
      
      const selectedDocs = getSelectedDocIds();
      const body = new URLSearchParams();
      body.append("msg", text);
      const historyText = chatHistory.slice(-10).map(m => 
      `${m.role === "user" ? "User" : "Assistant"}: ${m.content}`
      ).join("\n");
      if (historyText) {
      body.append("history", historyText);
      }
      if (selectedDocs.length > 0) {
        body.append("doc_ids", selectedDocs.join(","));
      }

      const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body
      });

      const raw = await res.text();
      let answerText = raw;
      let sources = [];
      let hypothesis = null;
      let timing = null;
      let chatHistory = [];

      try {
        const maybe = JSON.parse(raw);
        if (maybe && typeof maybe === "object") {
          answerText = maybe.answer || maybe.text || raw;
          sources = Array.isArray(maybe.sources) ? maybe.sources : [];
          chatHistory.push({role: "assistant", content: answerText});
          hypothesis = maybe.hypothesis;
          timing = maybe.timing;
        }
      } catch (_) {}
      addMessage({ role: "bot", text: answerText, sources });
      chatHistory.push({role: "assistant", content: answerText}); 

      // Show HyDE info if available
      if (hypothesis) {
        const hydeInfo = document.getElementById("hydeInfo");
        const hydeHypothesis = document.getElementById("hydeHypothesis");
        hydeHypothesis.textContent = `Generated hypothesis: "${hypothesis.substring(0, 150)}..." (${timing?.hypothesis_generation}s)`;
        hydeInfo.classList.remove("d-none");
        setTimeout(() => hydeInfo.classList.add("d-none"), 10000); // Hide after 10s
      }

      addMessage({ role: "bot", text: answerText, sources });
    } catch (err) {
      addMessage({
        role: "bot",
        text: "Sorry — I couldn't reach the server. Please try again."
      });
    } finally {
      setTyping(false);
      sendBtn.disabled = false;
      inputEl.focus();
    }
  });

  // Initialize
  loadDocuments();
  inputEl.focus();
</script>
</body>
</html>